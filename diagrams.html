<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BAT VR Sales Trainer ‚Äî Architecture Diagrams</title>
<script src="https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.min.js"></script>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: #0d1117;
    color: #e6edf3;
    padding: 40px 20px;
  }
  .container { max-width: 1200px; margin: 0 auto; }
  h1 {
    font-size: 28px;
    margin-bottom: 4px;
    background: linear-gradient(135deg, #58a6ff, #bc8cff);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }
  .subtitle { color: #8b949e; margin-bottom: 48px; font-size: 14px; }
  .diagram-section {
    margin-bottom: 56px;
    background: #161b22;
    border: 1px solid #30363d;
    border-radius: 12px;
    overflow: hidden;
  }
  .diagram-header { padding: 20px 24px 0; }
  .diagram-header h2 { font-size: 18px; color: #e6edf3; margin-bottom: 4px; }
  .diagram-header p { font-size: 13px; color: #8b949e; margin-bottom: 16px; }
  .mermaid { padding: 24px; display: flex; justify-content: center; overflow-x: auto; }
  .mermaid svg { max-width: 100%; height: auto; }
  .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
  @media (max-width: 900px) { .grid { grid-template-columns: 1fr; } }
  .badge { display: inline-block; font-size: 11px; padding: 2px 8px; border-radius: 10px; font-weight: 600; margin-right: 6px; }
  .badge-ws { background: #1f6feb33; color: #58a6ff; border: 1px solid #1f6feb; }
  .badge-rest { background: #23883233; color: #3fb950; border: 1px solid #238832; }
  .badge-data { background: #9e6a0333; color: #d29922; border: 1px solid #9e6a03; }
  .badge-client { background: #8b5cf633; color: #bc8cff; border: 1px solid #8b5cf6; }
</style>
</head>
<body>
<div class="container">

<h1>BAT VR Sales Trainer ‚Äî Architecture</h1>
<p class="subtitle">Express + WebSocket + MongoDB ¬∑ Unity VR + Web + Dashboard ¬∑ 5 Personas</p>

<!-- 1. System Overview -->
<div class="diagram-section">
  <div class="diagram-header">
    <h2>1. System Overview</h2>
    <p><span class="badge badge-client">Clients</span><span class="badge badge-ws">WebSocket</span><span class="badge badge-rest">REST</span><span class="badge badge-data">Data</span></p>
  </div>
  <div class="mermaid">
graph TB
    subgraph Clients["üéÆ Clients"]
        UNITY["Unity VR Client<br/><i>Pico 4 ¬∑ hand tracking</i>"]
        WEB["Web Client<br/><i>Lite version ¬∑ Sway Meter</i>"]
        DASH["Dashboard<br/><i>Session list ¬∑ PDF download</i>"]
    end

    subgraph Server["‚ö° Express Server"]
        direction TB
        WSR["WS Relay<br/>Manager"]
        REST["REST API"]
        SUP["Supervisor<br/><i>sales steps + attitude</i>"]
        SCO["Scoring<br/><i>per-persona criteria</i>"]
        EVT["Events<br/>Service"]
        RPT["PDF Report"]
        EXP["Export<br/><i>BatMan API</i>"]
        DW["Data Writer<br/><i>session/events/transcript</i>"]
    end

    subgraph External["üåê External"]
        OAI["OpenAI Realtime API<br/><i>gpt-4o-realtime</i>"]
        GPT["OpenAI Chat API<br/><i>gpt-4.1</i>"]
        BAT["BatMan API<br/><i>BAT L&D system</i>"]
    end

    DB[("MongoDB<br/>sessions ¬∑ personas")]
    FS[("File System<br/>data/sessions/{id}/")]

    UNITY -- "WS: audio + VR events" --> WSR
    WEB -- "WS: audio" --> WSR
    UNITY -- "REST" --> REST
    WEB -- "REST" --> REST
    DASH -- "REST" --> REST

    WSR <-- "WS: Realtime" --> OAI
    WSR <--> SUP
    WSR --> EVT
    SUP -- "evaluate" --> GPT
    SCO -- "score" --> GPT
    EXP -- "POST data" --> BAT

    REST --> SCO
    REST --> RPT
    REST --> EXP

    REST <--> DB
    WSR --> DB
    SCO --> DB
    DW --> FS

    style Clients fill:#1a1e2e,stroke:#8b5cf6,stroke-width:2px,color:#e6edf3
    style Server fill:#1a2e1a,stroke:#3fb950,stroke-width:2px,color:#e6edf3
    style External fill:#2e1a1a,stroke:#f47067,stroke-width:2px,color:#e6edf3
  </div>
</div>

<!-- 2. WebSocket Relay -->
<div class="diagram-section">
  <div class="diagram-header">
    <h2>2. WebSocket Relay ‚Äî Audio + Events + Supervisor</h2>
    <p><span class="badge badge-ws">WebSocket</span> Full session lifecycle with VR events and server-side supervisor</p>
  </div>
  <div class="mermaid">
sequenceDiagram
    participant C as Unity / Web Client
    participant S as Express Server
    participant OAI as OpenAI Realtime
    participant SUP as Supervisor (GPT-4.1)

    Note over C,OAI: üü¢ Session Start
    C->>S: POST /api/sessions {scenarioId, traineeId}
    S->>S: Create session in MongoDB
    S-->>C: {sessionId, wsUrl, persona}

    C->>S: WS Connect /ws/sessions/{id}
    S->>OAI: WS Connect (persona prompt + product knowledge + tools)
    S-->>C: {type: "ready"}
    S->>S: Log event: SYSTEM / Session_Start

    Note over C,OAI: üé§ Audio Loop
    loop Audio chunks
        C->>S: {type: "audio", data: "base64..."}
        S->>OAI: input_audio_buffer.append
    end

    OAI->>S: transcription.completed (user speech)
    S->>S: Store transcript: TRAINEE
    S-->>C: {type: "transcript", speaker: "TRAINEE", text: "..."}

    OAI->>S: audio.delta (streaming avatar voice)
    S-->>C: {type: "audio", data: "base64..."}

    OAI->>S: audio_transcript.done (avatar speech)
    S->>S: Store transcript: AVATAR
    S-->>C: {type: "transcript", speaker: "AVATAR", text: "..."}

    Note over C,S: üéÆ VR Events (Unity sends during session)
    C->>S: {type: "event", data: {type: "VR_INTERACTION", ...}}
    S->>S: Log event with timestamp
    C->>S: {type: "event", data: {type: "DOB_CHECK", ...}}
    S->>S: Log event with timestamp

    Note over S,SUP: üß† Supervisor (2s debounce after assistant msg)
    S->>SUP: Transcript + VR events + sales steps + persona context
    SUP-->>S: {attitude, guidance, salesSteps, shouldEnd}
    S->>S: Log event: SUPERVISOR
    S->>OAI: conversation.item.create (state injection)
    S-->>C: {type: "attitude", value: 5, direction: "rising"}

    Note over C,OAI: üî¥ Session End
    OAI->>S: function_call: end_conversation({reason})
    S->>S: Wait for audio (~5s)
    S->>OAI: Close WS
    S-->>C: {type: "session_ended", outcome: "converted"}

    Note over S,SUP: üìä Post-Session
    S->>SUP: Score full session (GPT-4.1)
    SUP-->>S: {overall: 75, categories, highlights, improvements}
    S->>S: Save to MongoDB
    S->>S: Write session.json + events.json + transcript.json
    S-->>C: {type: "score", data: {...}}
  </div>
</div>

<!-- 3. REST API -->
<div class="diagram-section">
  <div class="diagram-header">
    <h2>3. REST API Endpoints</h2>
    <p><span class="badge badge-rest">REST</span> All HTTP endpoints</p>
  </div>
  <div class="mermaid">
graph LR
    subgraph WS["üîå WebSocket"]
        W1["WSS /ws/sessions/:id<br/><i>audio relay + VR events</i>"]
    end

    subgraph Sessions["üìã Sessions"]
        S1["POST /api/sessions<br/><i>Create session</i>"]
        S2["GET /api/sessions/:id<br/><i>Get session detail</i>"]
        S3["GET /api/sessions<br/><i>List sessions</i>"]
        S4["POST /api/sessions/:id/events<br/><i>Batch upload VR events</i>"]
    end

    subgraph Output["üìÑ Reports & Export"]
        R1["GET /api/sessions/:id/report<br/><i>Download PDF report card</i>"]
        R2["POST /api/sessions/:id/export<br/><i>Upload to BatMan API</i>"]
        R3["GET /api/sessions/:id/data<br/><i>Download structured data ZIP</i>"]
    end

    subgraph Config["üé≠ Config"]
        SC1["GET /api/scenarios<br/><i>List scenarios</i>"]
        SC2["GET /api/personas<br/><i>List personas</i>"]
    end

    subgraph Dash["üìä Dashboard"]
        D1["GET /api/dashboard<br/><i>Session list + basic stats</i>"]
        D2["GET /api/dashboard/stats<br/><i>Aggregate analytics</i>"]
    end

    style WS fill:#1a2a2e,stroke:#58a6ff,color:#e6edf3
    style Sessions fill:#1a2e1a,stroke:#3fb950,color:#e6edf3
    style Output fill:#2e2a1a,stroke:#d29922,color:#e6edf3
    style Config fill:#1a1e2e,stroke:#8b5cf6,color:#e6edf3
    style Dash fill:#2e1a2a,stroke:#f47067,color:#e6edf3
  </div>
</div>

<!-- 4. Structured Data -->
<div class="diagram-section">
  <div class="diagram-header">
    <h2>4. Structured Data Output</h2>
    <p><span class="badge badge-data">Data</span> File structure per session</p>
  </div>
  <div class="mermaid">
graph TB
    SE[/"üîö Session Ends"/]
    SE --> SCORE["üß† Scoring<br/><i>GPT-4.1 per-persona criteria</i>"]
    SCORE --> SAVE["üíæ MongoDB<br/><i>full session record</i>"]
    SAVE --> WRITE["üìÅ Write Data Files"]

    WRITE --> FOLDER["sessions/BAT-001/"]

    FOLDER --> SJ["session.json<br/><i>sessionId, traineeId, persona<br/>outcome, score, moodHistory</i>"]
    FOLDER --> EJ["events.json<br/><i>NDJSON: VR_INTERACTION<br/>TABLET_CHOICE, DOB_CHECK<br/>SUPERVISOR, SYSTEM, ERROR</i>"]
    FOLDER --> TJ["transcript.json<br/><i>NDJSON: startTime, endTime<br/>speaker: AVATAR / TRAINEE<br/>text</i>"]

    SAVE --> PDF["üìÑ PDF Report<br/><i>on demand</i>"]
    SAVE --> BATMAN["‚òÅÔ∏è BatMan API<br/><i>on demand</i>"]
    SAVE --> ZIP["üì¶ ZIP Download<br/><i>on demand</i>"]

    style SE fill:#f47067,stroke:#f47067,color:#fff
    style SCORE fill:#1f6feb,stroke:#1f6feb,color:#fff
    style SAVE fill:#d29922,stroke:#d29922,color:#fff
    style WRITE fill:#3fb950,stroke:#3fb950,color:#fff
    style FOLDER fill:#238636,stroke:#238636,color:#fff
    style SJ fill:#161b22,stroke:#58a6ff,color:#e6edf3
    style EJ fill:#161b22,stroke:#58a6ff,color:#e6edf3
    style TJ fill:#161b22,stroke:#58a6ff,color:#e6edf3
    style PDF fill:#8b5cf6,stroke:#8b5cf6,color:#fff
    style BATMAN fill:#f47067,stroke:#f47067,color:#fff
    style ZIP fill:#d29922,stroke:#d29922,color:#fff
  </div>
</div>

<!-- 5. Personas -->
<div class="diagram-section">
  <div class="diagram-header">
    <h2>5. Persona System ‚Äî 5 Customer Types</h2>
    <p><span class="badge badge-client">Personas</span> Each has unique prompts, evaluation criteria, and product knowledge</p>
  </div>
  <div class="mermaid">
graph TB
    subgraph Personas["üé≠ 5 Customer Personas"]
        P1["üö¨ FMC Smoker<br/><i>Traditional cigarette loyalist<br/>Skeptical, brand-attached</i>"]
        P2["üíä Velo User<br/><i>Nicotine pouch user<br/>Already alternative, why switch?</i>"]
        P3["üîô Glo Lapsed<br/><i>Former glo user<br/>Bad experience, needs re-convincing</i>"]
        P4["ü§î Curious Newcomer<br/><i>Never tried alternatives<br/>Open but confused</i>"]
        P5["üò§ Hostile / No Time<br/><i>Negative, in a rush<br/>Doesn't want to be bothered</i>"]
    end

    subgraph PerPersona["Each Persona Has"]
        PP1["Realtime Prompt<br/><i>personality, speech style<br/>objections, product awareness</i>"]
        PP2["Supervisor Prompt<br/><i>evaluation criteria<br/>BAT sales steps checklist<br/>attitude shift rules</i>"]
        PP3["Scoring Prompt<br/><i>weighted categories<br/>persona-specific expectations</i>"]
        PP4["Product Knowledge<br/><i>what they know/don't know<br/>about glo, neo, veo</i>"]
    end

    P1 --> PerPersona
    P2 --> PerPersona
    P3 --> PerPersona
    P4 --> PerPersona
    P5 --> PerPersona

    style Personas fill:#1a1e2e,stroke:#8b5cf6,stroke-width:2px,color:#e6edf3
    style PerPersona fill:#2e2a1a,stroke:#d29922,stroke-width:2px,color:#e6edf3
  </div>
</div>

<!-- 6. Client architectures -->
<div class="grid">

<div class="diagram-section">
  <div class="diagram-header">
    <h2>6a. Unity VR Client (Pico 4)</h2>
    <p><span class="badge badge-client">Client</span> Hands-free ¬∑ hand tracking ¬∑ 3D environment</p>
  </div>
  <div class="mermaid">
graph TB
    subgraph Unity["Unity VR (Pico 4)"]
        MIC["üé§ Microphone<br/><i>PCM16 capture</i>"]
        SPK["üîä AudioSource<br/><i>avatar voice playback</i>"]
        SM["Session Manager<br/><i>REST + WS</i>"]
        EVT["Event Tracker<br/><i>VR interactions<br/>product pickups<br/>tablet choices</i>"]
        UI["VR UI<br/><i>sway meter<br/>transcript overlay</i>"]
        AVA["3D Avatar<br/><i>lipsync<br/>behavioral blending</i>"]
        ENV["Environment<br/><i>Valmont store ¬∑ street<br/>distractions</i>"]
    end

    API["Express Server"]

    MIC --> SM
    EVT --> SM
    SM -- "WS" --> API
    API -- "WS" --> SM
    SM --> SPK
    SM --> UI
    SM --> AVA
    SM --> ENV

    style Unity fill:#1a1e2e,stroke:#8b5cf6,stroke-width:2px,color:#e6edf3
  </div>
</div>

<div class="diagram-section">
  <div class="diagram-header">
    <h2>6b. Web Lite + Dashboard</h2>
    <p><span class="badge badge-client">Client</span> Browser / tablet ¬∑ same backend</p>
  </div>
  <div class="mermaid">
graph TB
    subgraph Web["Web Lite (React)"]
        MIC2["üé§ Browser mic"]
        SWAY["Sway Meter<br/><i>Red/Green pulse<br/>real-time sentiment</i>"]
        TRANS["Transcript<br/>Display"]
        SCORE2["Score Card"]
    end

    subgraph Dashboard["Dashboard"]
        LIST["üìã Session List<br/><i>ID ¬∑ trainee ¬∑ persona<br/>outcome ¬∑ score ¬∑ date</i>"]
        DL["üìÑ PDF Download"]
        STATS["üìä Stats<br/><i>avg score ¬∑ rates</i>"]
    end

    API["Express Server"]

    MIC2 -- "WS" --> API
    API -- "WS" --> SWAY
    API --> TRANS
    API --> SCORE2
    LIST --> API
    DL --> API
    STATS --> API

    style Web fill:#1a2e1a,stroke:#3fb950,stroke-width:2px,color:#e6edf3
    style Dashboard fill:#2e1a2a,stroke:#f47067,stroke-width:2px,color:#e6edf3
  </div>
</div>

</div>

<!-- 7. Server Internals -->
<div class="diagram-section">
  <div class="diagram-header">
    <h2>7. Server Module Map</h2>
    <p>Internal structure of the Express backend</p>
  </div>
  <div class="mermaid">
graph TB
    subgraph Entry["Entry"]
        SRV["server.ts<br/><i>Express + WS</i>"]
        CFG["config.ts"]
    end

    subgraph Routes["routes/"]
        RS["sessions.ts"]
        RSC["scenarios.ts"]
        RD["dashboard.ts"]
    end

    subgraph WS["ws/"]
        WR["relay.ts<br/><i>client ‚Üî OpenAI</i>"]
        WH["handlers.ts<br/><i>audio + events</i>"]
    end

    subgraph Services["services/"]
        SO["openai.ts"]
        SS["supervisor.ts<br/><i>+ BAT sales steps</i>"]
        SSC["scoring.ts<br/><i>per-persona</i>"]
        SP["prompt.ts"]
        SR["report.ts<br/><i>PDF</i>"]
        SE["export.ts<br/><i>BatMan API</i>"]
        SDW["data-writer.ts<br/><i>structured files</i>"]
    end

    subgraph DB["db/"]
        DC["connection.ts"]
        DS["sessions.ts"]
        DP["personas.ts"]
    end

    SRV --> Routes
    SRV --> WS
    Routes --> Services
    WS --> Services
    Services --> DB
    Routes --> DB

    WR --> SO
    WR --> SS
    RS --> SSC
    RS --> SR
    RS --> SE
    RS --> SDW

    style Entry fill:#161b22,stroke:#30363d,color:#e6edf3
    style Routes fill:#1a2e1a,stroke:#3fb950,color:#e6edf3
    style WS fill:#1a2a2e,stroke:#58a6ff,color:#e6edf3
    style Services fill:#2e2a1a,stroke:#d29922,color:#e6edf3
    style DB fill:#2e1a1a,stroke:#f47067,color:#e6edf3
  </div>
</div>

</div>

<script>
  mermaid.initialize({
    startOnLoad: true,
    theme: 'dark',
    themeVariables: {
      primaryColor: '#1f6feb',
      primaryTextColor: '#e6edf3',
      primaryBorderColor: '#30363d',
      lineColor: '#8b949e',
      secondaryColor: '#161b22',
      tertiaryColor: '#0d1117',
      fontFamily: '-apple-system, BlinkMacSystemFont, Segoe UI, Roboto, sans-serif',
      fontSize: '13px',
      noteBkgColor: '#161b22',
      noteTextColor: '#8b949e',
      noteBorderColor: '#30363d',
      actorBkg: '#1f6feb',
      actorTextColor: '#fff',
      actorLineColor: '#8b949e',
      signalColor: '#e6edf3',
    },
    sequence: { mirrorActors: false, messageMargin: 40, actorMargin: 80, width: 180 },
    flowchart: { htmlLabels: true, curve: 'basis', padding: 15, nodeSpacing: 30, rankSpacing: 40 }
  });
</script>
</body>
</html>
